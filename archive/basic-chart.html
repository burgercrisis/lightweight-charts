<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic Chart Example</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #chart-container {
            width: 800px;
            height: 500px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <h1>Basic Chart Example</h1>
    <p id="status">Loading chart...</p>
    <div id="chart-container"></div>

    <script type="module">
        import { createChart } from 'lightweight-charts';

        const statusElement = document.getElementById('status');
        const setStatus = (text) => {
            if (statusElement) {
                statusElement.textContent = text;
            }
        };

        try {
            const container = document.getElementById('chart-container');
            const chart = createChart(container, {
                width: 800,
                height: 500,
                layout: {
                    backgroundColor: '#111827',
                    textColor: '#e5e7eb',
                },
                grid: {
                    vertLines: {
                        color: '#1f2933',
                    },
                    horzLines: {
                        color: '#1f2933',
                    },
                },
                timeScale: {
                    timeVisible: true,
                    secondsVisible: false,
                },
                rightPriceScale: {
                    borderVisible: false,
                },
            });

            const candleSeries = chart.addCandlestickSeries({
                upColor: '#22c55e',
                downColor: '#ef4444',
                borderVisible: false,
                wickUpColor: '#22c55e',
                wickDownColor: '#ef4444',
            });

            const candles = [];

            const addPriceSample = (price, timestampSec) => {
                if (!Number.isFinite(price)) {
                    return;
                }

                const last = candles[candles.length - 1];

                // Build simple 1-minute candles from the polled price feed
                if (!last || timestampSec - last.time >= 60) {
                    candles.push({
                        time: timestampSec,
                        open: price,
                        high: price,
                        low: price,
                        close: price,
                    });
                } else {
                    last.high = Math.max(last.high, price);
                    last.low = Math.min(last.low, price);
                    last.close = price;
                }

                if (candles.length > 500) {
                    candles.shift();
                }

                candleSeries.setData(candles);
            };

            const fetchLatestPrice = async () => {
                try {
                    const response = await fetch('https://api.dexscreener.com/latest/dex/pairs/solana/4xxM4cdb6MEsCxM52xvYqkNbzvdeWWsPDZrBcTqVGUar');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    const pair = data.pair ?? (Array.isArray(data.pairs) ? data.pairs[0] : null);

                    if (!pair || !pair.priceNative) {
                        throw new Error('Missing price data in response');
                    }

                    const price = Number(pair.priceNative); // GIGACHAD price in SOL
                    const nowSec = Math.floor(Date.now() / 1000);

                    addPriceSample(price, nowSec);
                    setStatus('Live GIGACHAD / SOL feed (Dexscreener)');
                } catch (error) {
                    console.error('Failed to load GIGACHAD price', error);
                    setStatus(`Error loading data: ${error?.message ?? error}`);
                }
            };

            (async () => {
                await fetchLatestPrice();
                // Poll every 10 seconds for a new price sample
                setInterval(fetchLatestPrice, 10000);
            })();
        } catch (error) {
            console.error('Chart initialization failed', error);
            setStatus(`Chart error: ${error?.message ?? error}`);
        }
    </script>
</body>
</html>
